<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Prompt Enhancer</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <nav class="navbar">
            <div class="brand">
                Prompt<span class="highlight">Engineer</span>
            </div>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" aria-label="Toggle Dark Mode">
                    <input type="checkbox" id="checkbox" />
                    <span class="slider round"></span>
                </label>
            </div>
        </nav>

        <div class="container">
            <header class="hero">
                <h1>Refine your logic.</h1>
                <p class="subtitle">
                    Transform basic ideas into bulletproof LLM prompts.
                </p>
            </header>

            <form method="POST" class="main-form">
                <div class="form-group primary-group">
                    <label for="base_prompt">What do you want to build?</label>
                    <textarea
                        id="base_prompt"
                        name="base_prompt"
                        rows="3"
                        placeholder="e.g. Write a Python script to scrape stock prices..."
                        required
                    >
{{ request.form.get('base_prompt', '') }}</textarea
                    >
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="role">AI Persona</label>
                        <input
                            type="text"
                            id="role"
                            name="role"
                            value="{{ request.form.get('role', '') }}"
                            placeholder="e.g. Senior DevOps Engineer"
                        />
                    </div>

                    <div class="form-group">
                        <label for="format">Output Format</label>
                        <input
                            type="text"
                            id="format"
                            name="format"
                            value="{{ request.form.get('format', '') }}"
                            placeholder="e.g. Markdown, JSON, CSV"
                        />
                    </div>
                </div>

                <div class="form-group">
                    <label for="task">Specific Task Details</label>
                    <textarea
                        id="task"
                        name="task"
                        rows="2"
                        placeholder="e.g. The script should run every hour and save to a CSV..."
                    >
{{ request.form.get('task', '') }}</textarea
                    >
                </div>

                <div class="dynamic-sections">
                    <div class="form-group" id="context-section">
                        <div class="label-row">
                            <label>Context</label>
                            <button
                                type="button"
                                id="add-context"
                                class="btn-text"
                            >
                                + Add
                            </button>
                        </div>
                        <div id="context-inputs" class="dynamic-list">
                            {% for item in request.form.getlist('context[]') %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    name="context[]"
                                    value="{{ item }}"
                                />
                                <button type="button" class="remove-input">
                                    ×
                                </button>
                            </div>
                            {% endfor %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    name="context[]"
                                    placeholder="e.g. Using Python 3.11"
                                />
                                <button
                                    type="button"
                                    class="remove-input"
                                    style="display: none"
                                >
                                    ×
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="constraints-section">
                        <div class="label-row">
                            <label>Constraints</label>
                            <button
                                type="button"
                                id="add-constraint"
                                class="btn-text"
                            >
                                + Add
                            </button>
                        </div>
                        <div id="constraints-inputs" class="dynamic-list">
                            {% for item in request.form.getlist('constraint[]')
                            %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    name="constraint[]"
                                    value="{{ item }}"
                                />
                                <button type="button" class="remove-input">
                                    ×
                                </button>
                            </div>
                            {% endfor %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    name="constraint[]"
                                    placeholder="e.g. No external libraries"
                                />
                                <button
                                    type="button"
                                    class="remove-input"
                                    style="display: none"
                                >
                                    ×
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="examples-section">
                        <div class="label-row">
                            <label>Examples</label>
                            <button
                                type="button"
                                id="add-example"
                                class="btn-text"
                            >
                                + Add
                            </button>
                        </div>
                        <div id="examples-inputs" class="dynamic-list">
                            {% for item in request.form.getlist('example[]') %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    name="example[]"
                                    value="{{ item }}"
                                />
                                <button type="button" class="remove-input">
                                    ×
                                </button>
                            </div>
                            {% endfor %}
                            <div class="input-group">
                                <input
                                    type="text"
                                    name="example[]"
                                    placeholder="e.g. Input: A, Output: B"
                                />
                                <button
                                    type="button"
                                    class="remove-input"
                                    style="display: none"
                                >
                                    ×
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-button">
                    Enhance Prompt ✨
                </button>
            </form>

            {% if ai_enhanced_prompt_output %}
            <div class="results-wrapper">
                <div class="output-card enhanced">
                    <div class="card-header">
                        <h2>Enhanced Prompt</h2>
                        <button
                            class="btn-icon"
                            onclick="copyToClipboard('enhanced-ai-output')"
                            title="Copy"
                        >
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="9"
                                    y="9"
                                    width="13"
                                    height="13"
                                    rx="2"
                                    ry="2"
                                ></rect>
                                <path
                                    d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                                ></path>
                            </svg>
                        </button>
                    </div>
                    <textarea class="prompt-output enhanced-ai-output" readonly>
{{ ai_enhanced_prompt_output }}</textarea
                    >
                </div>

                {% if ai_pitfalls_output %}
                <div class="output-card pitfalls">
                    <div class="card-header">
                        <h2>Analysis & Pitfalls</h2>
                    </div>
                    <textarea class="prompt-output pitfalls-output" readonly>
{{ ai_pitfalls_output }}</textarea
                    >
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <script>
            // --- Dark Mode Logic ---
            const checkbox = document.getElementById("checkbox");

            // Check local storage or system preference
            const savedTheme = localStorage.getItem("theme");
            const systemDark = window.matchMedia(
                "(prefers-color-scheme: dark)",
            ).matches;

            if (savedTheme === "dark" || (!savedTheme && systemDark)) {
                document.body.classList.add("dark-mode");
                checkbox.checked = true;
            }

            checkbox.addEventListener("change", () => {
                if (checkbox.checked) {
                    document.body.classList.add("dark-mode");
                    localStorage.setItem("theme", "dark");
                } else {
                    document.body.classList.remove("dark-mode");
                    localStorage.setItem("theme", "light");
                }
            });

            // --- Dynamic Inputs Logic ---
            function setupDynamicInputs(
                addButtonId,
                containerId,
                inputName,
                placeholder,
            ) {
                const btn = document.getElementById(addButtonId);
                const container = document.getElementById(containerId);

                // Helper to update visibility of remove buttons
                const updateRemoveButtons = () => {
                    const groups = container.querySelectorAll(".input-group");
                    groups.forEach((group) => {
                        const input = group.querySelector("input");
                        const removeBtn = group.querySelector(".remove-input");
                        // Show remove if there's value OR if it's not the only input
                        if (input.value.trim() !== "" || groups.length > 1) {
                            removeBtn.style.display = "flex";
                        } else {
                            removeBtn.style.display = "none";
                        }
                    });
                };

                btn.addEventListener("click", () => {
                    const div = document.createElement("div");
                    div.className = "input-group";
                    div.innerHTML = `
                        <input type="text" name="${inputName}" placeholder="${placeholder}">
                        <button type="button" class="remove-input">×</button>
                    `;
                    container.appendChild(div);
                    updateRemoveButtons();
                });

                container.addEventListener("click", (e) => {
                    if (e.target.classList.contains("remove-input")) {
                        const group = e.target.closest(".input-group");
                        const allGroups =
                            container.querySelectorAll(".input-group");

                        if (allGroups.length > 1) {
                            group.remove();
                        } else {
                            // If it's the last one, just clear it
                            group.querySelector("input").value = "";
                        }
                        updateRemoveButtons();
                    }
                });

                container.addEventListener("input", updateRemoveButtons);
            }

            setupDynamicInputs(
                "add-context",
                "context-inputs",
                "context[]",
                "e.g. Using Python 3.11",
            );
            setupDynamicInputs(
                "add-constraint",
                "constraints-inputs",
                "constraint[]",
                "e.g. No external libraries",
            );
            setupDynamicInputs(
                "add-example",
                "examples-inputs",
                "example[]",
                "e.g. Input: A, Output: B",
            );

            // --- Clipboard Logic ---
            async function copyToClipboard(className) {
                const el = document.querySelector("." + className);
                try {
                    await navigator.clipboard.writeText(el.value);
                    // Visual feedback could go here
                } catch (err) {
                    console.error("Failed to copy", err);
                }
            }
        </script>
    </body>
</html>
